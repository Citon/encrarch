<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>encrarch - Encrypt and Archive</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="encrarch-encrypt-and-archive">
<h1 class="title">encrarch - Encrypt and Archive</h1>

<p><strong>encrarch</strong> uses GnuPG to create an encrypted archive of one or more files in a source directory.  Its main use is for securely storing disk 2 disk backups on removable media, like external hard drives.  The removable media can be manually rotated on a schedule to create weekly, monthly, yearly, etc. archives.</p>
<p><strong>encrarch</strong> relies on GnuPG.  Safe key handling is crucial to the security of the system, and your ability to recover from the encrypted backups.  (See PRECAUTIONS)</p>
<div class="section" id="requirements">
<h1>REQUIREMENTS</h1>
<ul class="simple">
<li>Designed for UNIX/Linux - May require modification to run on Windows</li>
<li>Python 2.6+</li>
<li>GnuPG</li>
</ul>
</div>
<div class="section" id="installation">
<h1>INSTALLATION</h1>
<ul class="simple">
<li>Install the python-gnupg package from <a class="reference external" href="http://code.google.com/p/python-gnupg/">http://code.google.com/p/python-gnupg/</a>
(Example shows fetching current version - Adjust accordingly)</li>
</ul>
<pre class="literal-block">
cd /tmp
wget &quot;http://python-gnupg.googlecode.com/files/python-gnupg-0.2.8.tar.gz&quot;
tar xvzf python-gnupg-0.2.8.tar.gz
cd python-gnupg-0.2.8
python setup.py install
</pre>
<ul class="simple">
<li>For standard systems, copy encrarch.py into /usr/local/bin</li>
</ul>
<pre class="literal-block">
cp encrarch.py /usr/local/bin
</pre>
<ul class="simple">
<li>For QNAP or other systems that use a &quot;ramdrive&quot; that is erased on boot up, store <em>encrarch.py</em> in a persistent location.  (For instance, on QNAP, under a share.)  <strong>GnuPG settings and keys will also be lost on reboot for most of these systems.  Make sure to save the user's ~/.gnupg folder after making changes.  A simple script to copy this back into place on boot will take care of the rest.</strong></li>
</ul>
</div>
<div class="section" id="gnupg-setup-and-key-handling">
<h1>GNUPG SETUP AND KEY HANDLING</h1>
<p>For those unfamiliar with Gnu Privacy Guard, some basic setup is required before use.</p>
<ul class="simple">
<li>A pubic/secret keypair must be created.  As the user that will run <em>encrarch.py</em>, you can create a new key as follows:</li>
</ul>
<pre class="literal-block">
gpg --gen-key

# Choose RSA and RSA for the key type
# Choose 2048 as the key size
# Set key NOT to expire (0)
# Confirm that the key should not expire at all
# Set a real name for the key like &quot;HOSTNAME encrarch&quot; - Example: &quot;nas1 encrarch&quot;
# Set an email address like hostname.encrarch&#64;customerdomain - Example: nas1.encrarch&#64;example.net
# Set a comment if desired
# Press O to okay the key settings
# Enter a STRONG passphrase - DO NOT REUSE THIS PHRASE OR USE AN EXISTING PASSWORD!
# Note the pub key's ID, which follows &quot;pub 2048/&quot; in the returned text.  (You can also use gpg --list-keys to view the ID)
</pre>
<ul class="simple">
<li>Note the key ID!  This will be used in the configuration</li>
<li>For best performance with good security, add the next two lines to the users ~/.gnupg/gpg.conf file to disable compression and use the fast and secure AES-128 cipher:</li>
</ul>
<pre class="literal-block">
personal-compress-preferences Uncompressed
personal-cipher-preferences AES
</pre>
<ul class="simple">
<li>Remember that ramdrive based systems will often DELETE /root/ and other user folders on reboot, so copy the ~/.gnupg folder to a persistent location on the system before rebooting and use the gnupghome configuration option in your encrarch config to point to the alternate location.</li>
</ul>
<p>This is the single most import part of this whole system: <strong>IF YOU LOSE THE SECRET KEY, YOU CAN NOT READ THE ARCHIVES!</strong> ALWAYS make an emergency backup of your secret (private) key!</p>
<ul class="simple">
<li>Insert an empty and formatted USB stick (preferably very small) into the system</li>
<li>Change directory to the base of the mounted thumb drive</li>
</ul>
<pre class="literal-block">
cd /mount/sda1
</pre>
<ul class="simple">
<li>Export your public and private keyrings to armored text files:</li>
</ul>
<pre class="literal-block">
# Use of a descriptive filename will help prevent confusion - SYSTEMNAME-YYYY-MM-DD is shown:
gpg -a --export &gt; SYSTEMNAME-YYYY-MM-DD-public.asc
gpg -a --export-secret-keys &gt; SYSTEMNAME-YYYY-MM-DD-private.asc

# Example: If the system was named ancient1 and the date was Jan. 13th, 1045:
gpg -a --export &gt; ancient1-1045-01-13-public.asc
gpg -a --export-secret-keys &gt; ancient1-1045-01-13-private.asc
</pre>
<ul class="simple">
<li>You may want to also copy this document (that you are reading right now) to the USB drive for an emergency reference.</li>
<li><strong>UNMOUNT THE THUMBDRIVE IMMEDIATELY AND STORE IN A VERY SECURE PLACE!</strong> - The exported keys are NOT protected!!</li>
<li><em>To import your private and public keys from the backup copy:</em></li>
</ul>
<pre class="literal-block">
gpg --import &lt; IMPORTKEYFILE
</pre>
</div>
<div class="section" id="precautions">
<h1>PRECAUTIONS</h1>
<p><strong>READ THESE PRECAUTIONS CAREFULLY!</strong> Failure to follow these guidelines may result in a useless archive or data theft!  Note the massive overuse of bold text and capitals below are for good reason.  Yes: I am yelling!</p>
<ul class="simple">
<li><strong>PRIVATE KEYS EXPORTED TO USB DRIVES ARE NOT ENCRYPTED!!!!</strong> - Unmount the drive and store in a safety deposit box or safe. It is for emergency use ONLY!</li>
<li><strong>YOUR DATA WILL NOT BE READABLE WITHOUT THE PRIVATE (SECRET) PGP KEY!!!</strong> - Make sure to save the USB backup somewhere safe. This can be in the same vault or remote location as the removable hard drives containing the encrypted files.</li>
<li><strong>NEVER TRANSPORT THE USB BACKUP KEY WITH ANY DEVICE CONTAINING FILES ENCRYPTED FOR THE KEY!!!</strong> - If lost or stolen, someone with both the USB key and any form of encrypted files WILL be able to decrypt the files.</li>
<li><strong>IF YOU ARE USING A QNAP OR OTHER NAS WITH A RAMDISK</strong> - You need to take additional steps to SAVE the PGP keys on your system so they will not be lost on a reboot!  encrarch supports placing the user's keys and options into an alternate path instead of ~/.gnupg.</li>
<li><strong>TEST YOUR RECOVERY PROCESS!!!</strong> - What good is a backup you can't use?  Make sure to test your backup process, and include test recoveries of <em>encrarch</em> created archives with your regular disaster recovery tests.</li>
</ul>
</div>
<div class="section" id="configuration">
<h1>CONFIGURATION</h1>
<p>encrarch requires a Python configparser configuration file.  (Future versions may support full configuration via command line.)</p>
<p>Use the included <em>encrarch.conf-SAMPLE</em> as a starting point, copying it to <em>/etc/encrarch.conf</em> (standard systems) or in a safe/persistent location (QNAP/other flash systems).  If the file is not named <em>/etc/encrarch.conf</em>, you must set it via command line with the <em>-c CONFIGFILE</em> option.  Each configuration file defines a source, a destination, and a key to encrypt to.  Use multiple files as needed.</p>
<p>The following outlines configuration steps, showing example settings that may or may not be useful.  You MUST customize your configuration!</p>
<ul class="simple">
<li>Set an &quot;instance&quot; name - This is to distinguish between multiple jobs.  (The default of &quot;encrarch&quot; is fine if you are only running one encrarch job)</li>
</ul>
<pre class="literal-block">
instancename = encrarch
</pre>
<ul class="simple">
<li>Set the sourcebase to the directory you want to copy from.  This can contain subdirectories - encrarch will search for files to backup</li>
</ul>
<pre class="literal-block">
sourcebase = /mnt/backups
</pre>
<ul class="simple">
<li>Set the source file matching pattern.  For most D2D backups, using <em>.&lt;SUFFIXNAME&gt; is suitable.  (</em>.vbk for Veeam, <em>.spf|</em>.spi for Shadow Protect, etc)  See pydoc fnmatch for more information</li>
</ul>
<pre class="literal-block">
sourcematch = \*.vbk
</pre>
<ul class="simple">
<li>Enable skipping of older files with the same starting name.  Most backup systems create files that start with the job name and then have a timestamp.  For instance, VEEAM uses &quot;JOBNAMEYYYY-MM-DDThhmmss.vbk&quot;.  If multiple full backups are in the same folder and are part of the same job, this feature allows you to skip all but the latest (by modification stamp on the file).  Comment out to disable the feature.</li>
</ul>
<pre class="literal-block">
sourcejobnameregex = ^(.+)\d{4}\-\d{2}\-\d{2}T\d{6}\.vbk
</pre>
<ul class="simple">
<li>Set the base directory to archive to.  Archived files will be stored in time stamped subfolders of this base.</li>
</ul>
<pre class="literal-block">
destroot = /mnt/save
</pre>
<ul class="simple">
<li>Date format for first subfolder under destroot to save to - See the strftime() Python documentation for more options.  The default is %Y-%m which is YYYY-MM.  Using %Y-%m, you can call this every day and over time will end up with one folder per-month containing the last backup of the month.</li>
</ul>
<pre class="literal-block">
destdateformat = %Y-%m
</pre>
<ul class="simple">
<li>For large jobs, you may want to use a temp space to store a copy of the files being encrypted.  Set the tempbase value if you want to enable this behavior</li>
</ul>
<pre class="literal-block">
tempbase = /mnt/scratchdrive
</pre>
<ul class="simple">
<li>In some cases, you may even want to keep the temp copy around.  Set temppreserve to true to prevent deletion of temp files after encrypting</li>
</ul>
<pre class="literal-block">
temppreserve = true
</pre>
<ul class="simple">
<li>If the gpg binary is not installed under a folder listed in your PATH, or if your PATH is not set, (as the case in some crude crons), gpgbinary should be set to the full path to your gpg binary. Uncomment to keep the default (just &quot;gpg&quot;)</li>
</ul>
<pre class="literal-block">
gpgbinary = /opt/gnupg/bin/gpg
</pre>
<ul class="simple">
<li>If you are running encrarch as an alternate user, or if you have moved your GnuPG configuration and key files to an alternate location, you can set gnupghome to the full path for the alternate .gnupg folder.  If not set, the default is /home/USERNAME/.gnupg</li>
</ul>
<pre class="literal-block">
gnupghome = /home/someotherdude/.gnupg
</pre>
<ul class="simple">
<li>You must set the GnuPG key you wish to encrypt TO.  Use &quot;gpg --list-keys&quot; to find the fingerprint, which is a 8 character hex value.  For example, for this output</li>
</ul>
<pre class="literal-block">
pub   2048D/A7D02D34 2011-01-09 [expires: 2013-01-08]
uid                  Paul M. Person &lt;paulguy&#64;thepaulguy.int&gt;
</pre>
<ul class="simple">
<li>the ID is A7D02D34 and the configuration would be</li>
</ul>
<pre class="literal-block">
encryptto = A7D02D34
</pre>
<ul class="simple">
<li>Set syslog to true to enable writing log messages to the DAEMON syslog facility</li>
</ul>
<pre class="literal-block">
syslog = true
</pre>
<ul class="simple">
<li>You can log to an optional log file - Set filelog to the name of the file to enable</li>
</ul>
<pre class="literal-block">
logfile = &quot;/path/to/logfile&quot;
</pre>
<ul class="simple">
<li>If filelog is set, you can set a size limit (in bytes).  Set to 0 to allow infinite size. 1MB shown</li>
</ul>
<pre class="literal-block">
logfilesize = 1048576
</pre>
<ul class="simple">
<li>If a file size limit is set, you can set a number of old log files to keep</li>
</ul>
<pre class="literal-block">
logfilekeep = 7
</pre>
<ul class="simple">
<li>Email reports can be sent on &quot;errors&quot; or &quot;all&quot; conditions.  Comment out the emailon line if you do not want to send email</li>
</ul>
<pre class="literal-block">
emailon = errors
</pre>
<ul class="simple">
<li>If emailon is set, you must configure an SMTP server IP or domain name - SMTP auth is not supported at this time, so add the IP of the machine running encrarch to the list of allowed IPs in your SMTP server</li>
</ul>
<pre class="literal-block">
smtpserver = 10.11.12.13
</pre>
<ul class="simple">
<li>emailon also requires one or more email addresses to notify via email - Separate multiple addresses with commas</li>
</ul>
<pre class="literal-block">
emailto = jerry.only&#64;misfits.int, danzig&#64;danzigcorp.net
</pre>
<ul class="simple">
<li>Set the from email address</li>
</ul>
<pre class="literal-block">
emailfrom  = encrarch&#64;example.int
</pre>
<ul class="simple">
<li>Set the prefix for the Subject: line in email notices.  Additional information is added after the prefix.  Note that in the example below, encrarch replaces %(instancename)s with the <em>instancename</em> set at the top.  The setting below is recommended</li>
</ul>
<pre class="literal-block">
emailsubject = [%(instancename)s]
</pre>
<ul class="simple">
<li>While the logging module used by encrarch does allow for direct configuration via a config file, it is overkill at this time.  So, logging is always to syslog.  Set the level to log below.  The default is INFO.  Valid settings are: CRITICAL, ERROR, WARNING, INFO, or DEBUG</li>
</ul>
<pre class="literal-block">
loglevel = DEBUG
</pre>
<ul class="simple">
<li>Use of a PID file allows <em>encrarch</em> to exit if another run of the same instanc e name is in progress.  The setting below is usually fine, and will update automaticlly based on the instancename.</li>
</ul>
<pre class="literal-block">
pidfile = /var/tmp/%(instancename)s.pid
</pre>
</div>
<div class="section" id="usage">
<h1>USAGE</h1>
<p>If you run encrarch without any options, it will use the default configuration file <em>/etc/encrarch.conf</em></p>
<pre class="literal-block">
encrarch.py
</pre>
<p>Use the -c option to define an alternate configuration file</p>
<pre class="literal-block">
encrarch.py -c /some/other/encrarchconfig.conf
</pre>
<p>The encrarch process is as follows:</p>
<ul class="simple">
<li>The <em>sourcebase</em> path is searched for files matching <em>sourcematch</em></li>
<li>Free space under <em>destroot</em> is checked.  encrarch aborts if the destination path does not have the required free space to hold the addition contents being copied. (The larger your source, the more free space required.)</li>
<li>If <em>tempbase</em> is defined, subfolders matching the structure of <em>sourcebase</em> are created and then all files matching <em>sourcematch</em> are copied into the <em>tempbase</em> path</li>
<li>File by file (for each matching <em>sourcematch</em>)</li>
</ul>
<blockquote>
<ul class="simple">
<li>The source file is read from out of <em>tempbase</em>, if
set, or <em>sourcebase</em> if no temp base is defined</li>
<li>The source file is encrypted using GnuPG and the <em>encrypto</em> key</li>
<li>Encrypted data is written into <em>destroot</em>/<em>destdateformat</em>, where <em>destdateformat</em> is replaced using the current date.  If <em>tempbase</em> is used, the files are read from temp, else they are read directly from <em>sourcebase</em>.  Each file is saved to <em>SOURCEFILENAME.tmp</em> while writing</li>
<li>Once encryption completes for the file, it is renamed to <em>SOURCEFILENAME</em></li>
</ul>
</blockquote>
<ul class="simple">
<li>While running, encrarch logs messages to STDERR and to syslog using the the DAEMON facility.  In most cases, this means messages appear in /var/log/messages.</li>
<li>When complete, the free space in <em>destroot</em> is again checked.  A preemptive warning is sent if the next run would fail due to limited free space.</li>
<li>If <em>emailon</em> is set, email notification will be sent on and error (if set to &quot;error&quot;) or for either and error or a normal result (if set to &quot;all&quot;)</li>
<li>If <em>tempbase</em> IS set and <em>temppreserve</em> is NOT set, files are removed from <em>tempbase</em></li>
</ul>
<p>Recovery of data from an encrarch created archive set is a manual process, requiring free space to place the decrypted files and <strong>the GnuPG secret key</strong> to match the key used to encrypt.</p>
<ul class="simple">
<li>For each file you wish to recover:</li>
</ul>
<pre class="literal-block">
gpg -do DESTINATIONFILENAME SOURCEFILENAME

# For instance, if your archive is mounted under /mnt/sdc1, and you want
# to recover the file &quot;FullBackup.vbk.gpg&quot; from /mnt/sdc1/2012-11/FullBackup/
# to /share/Recovery/FullBackup.vbk :
gpg -do /share/Recovery/FullBackup.vbk /mnt/sdc1/2012-11/FullBackup/FullBackup.vbk.gpg
</pre>
</div>
<div class="section" id="additional-information">
<h1>ADDITIONAL INFORMATION</h1>
<ul class="simple">
<li><em>pydoc encrarch</em> - Embedded documentation from encrarch.py</li>
<li><em>man gpg</em> - GnuPG main manual page</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Authors:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<p>Paul M. Hirsch &lt;<a class="reference external" href="mailto:paul.hirsch&#64;citon.com">paul.hirsch&#64;citon.com</a>&gt;</p>
</div>
</div>
</body>
</html>
